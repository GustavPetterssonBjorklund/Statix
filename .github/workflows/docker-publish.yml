name: Publish Docker Images

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_NAMESPACE: ${{ vars.DOCKERHUB_NAMESPACE != '' && vars.DOCKERHUB_NAMESPACE || secrets.DOCKERHUB_USERNAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set build variables
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [[ "${GITHUB_REF_TYPE}" != "tag" ]]; then
            TAG="dev-${GITHUB_SHA::7}"
          fi

          VERSION="${TAG#v}"
          BUILT_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          if [[ "${VERSION}" == *"-"* ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          echo "built_at=${BUILT_AT}" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=${IS_PRERELEASE}" >> "$GITHUB_OUTPUT"

      - name: Generate node version.json
        shell: bash
        run: |
          cat > apps/node/version.json <<EOF
          {
            "version": "${{ steps.vars.outputs.version }}",
            "commit": "${{ github.sha }}",
            "builtAt": "${{ steps.vars.outputs.built_at }}"
          }
          EOF
          cat apps/node/version.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker metadata (node)
        id: meta_node
        uses: docker/metadata-action@v5
        with:
          images: docker.io/${{ env.DOCKERHUB_NAMESPACE }}/statix-node
          flavor: |
            latest=${{ steps.vars.outputs.is_prerelease == 'false' }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.tag }}
            type=raw,value=${{ steps.vars.outputs.version }}
            type=sha,prefix=sha-

      - name: Build and push node image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/node/Dockerfile
          push: true
          tags: ${{ steps.meta_node.outputs.tags }}
          labels: ${{ steps.meta_node.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Docker metadata (server)
        id: meta_server
        uses: docker/metadata-action@v5
        with:
          images: docker.io/${{ env.DOCKERHUB_NAMESPACE }}/statix-server
          flavor: |
            latest=${{ steps.vars.outputs.is_prerelease == 'false' }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.tag }}
            type=raw,value=${{ steps.vars.outputs.version }}
            type=sha,prefix=sha-

      - name: Build and push server image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: ${{ steps.meta_server.outputs.tags }}
          labels: ${{ steps.meta_server.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
